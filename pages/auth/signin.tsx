import { NextPage } from "next";
import Head from "next/head";
import AuthLayout from "@components/layouts/AuthLayout";
import { useEffect } from "react";
import { useForm } from 'react-hook-form'
import { useSession, signIn } from 'next-auth/react'
import type { SignInResponse } from 'next-auth/react'
import { useRouter } from 'next/router'

type TLogin = {
    username: string
    password: string
}

const Signin: NextPage = () => {
    const { data, status } = useSession()
    const router = useRouter()
    const { handleSubmit, register, setError, clearErrors, formState: { errors } } = useForm<TLogin>()

    const onSubmit = (data: TLogin): void => {
        clearErrors('username')
        signIn('credentials', {
            username: data.username,
            password: data.password,
            redirect: false

        }).then((resp: SignInResponse | undefined) => {

            if (resp?.error) {
                setError('username', { message: resp?.error })
            }
        })


    }

    useEffect(() => {

        if (status === 'authenticated') {
            if (data?.user.type === 'ADMIN') {

                router.push('/dashboard')
            }
            else {
                router.push('/exam')
            }
        }
    }, [status])



    return (
        <AuthLayout>
            <Head>
                <title>BAEKS - Psikotest</title>
                <meta name="description" content="Generated by create next app" />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            <main className='flex flex-col justify-center items-center min-h-screen w-full'>
                <div className='mb-12 w-2/6 text-center'>
                    <h1 className='text-2xl font-bold tracking-wider'>Masukan username dan password untuk memulai</h1>
                </div>



                <form className='flex flex-col justify-center items-center w-1/3 space-y-4 bg-gray-100 p-12 rounded-sm border border-gray-400' onSubmit={handleSubmit(onSubmit)}>
                    {
                        errors?.username?.message && <div className='mb-12 w-4/6 text-center text-sm text-red-500'>{errors?.username.message}</div>
                    }
                    <div className='flex flex-row justify-between items-center w-full'>
                        <label htmlFor="username" className='w-1/3 mr-2 text-sm'>Username</label>
                        <input
                            {...register('username')}
                            type="text"
                            id="username"
                            placeholder='Enter your username'
                            className='border border-gray-400 p-2 rounded text-sm focus:outline focus:outline-1 focus:outline-offset-2 focus:outline-gray-600 w-2/3'
                        />
                    </div>
                    <div className='flex flex-row justify-between items-center w-full'>
                        <label htmlFor="password" className='w-1/3 mr-2 text-sm'>Password</label>
                        <input
                            {...register('password')}
                            type="password"
                            id="password"
                            placeholder='Please enter your password'
                            className='border border-gray-400 p-2 rounded text-sm focus:outline focus:outline-1 focus:outline-offset-2 focus:outline-gray-600 w-2/3'
                        />
                    </div>
                    <div className='w-full'>
                        <button className='bg-gray-800 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full text-sm'>Sign in</button>
                    </div>

                </form>

            </main>
        </AuthLayout>
    )
}

export default Signin